<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libcortex: libcortex</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libcortex
   </div>
   <div id="projectbrief">Event loop library following a &quot;batteries included&quot; approach</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">libcortex </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a></p>
<p>libcortex provides an event loop implementation and follows a "batteries included" approach, i.e. it already contains the specific code to monitor certain event sources.</p>
<p>The code for the different event sources is split into separate plugins that are loaded on-demand during runtime. Hence, only the required plugins for a use-case are loaded and only their dependencies have to be met.</p>
<p>The code of libcortex itself is licensed under the MIT license. However, many plugins rely on third-party libraries with a different license. Please check the effective license for your specific use-case.</p>
<p>Please note, not all plugins are actively used and many are not yet feature-complete. Hence, check the corresponding source files if your use-case is already supported.</p>
<p>Actively used:</p><ul>
<li>curl</li>
<li>fork</li>
<li>libnl</li>
<li>pipe</li>
<li>popen</li>
<li>sdbus</li>
<li>signals</li>
<li>udev</li>
<li>writequeue</li>
</ul>
<p>Other modules:</p><ul>
<li>avahi</li>
<li>can</li>
<li>evdev</li>
<li>fanotify</li>
<li>inotify</li>
<li>libvirt</li>
<li>mqtt</li>
<li>netlink_ge</li>
<li>netlink_raw</li>
<li>nf_queue</li>
<li>nf_route_raw</li>
<li>pulseaudio</li>
<li>sd_journal</li>
<li>sip</li>
<li>uevents</li>
<li>v4l</li>
<li>xcb_randr</li>
</ul>
<h1><a class="anchor" id="autotoc_md0"></a>
Why do I need an event loop?</h1>
<p>A regular process of an application is single-threaded. If such an application is event-driven, i.e. waits on events from external sources and processes them, the <code>main()</code> function of the application usually does some initialization and then calls a special function from a corresponding library that will not return until the application should terminate. The name of this function usually contains "loop" or "process" in some form. This function starts a so-called event loop. Instead of polling the event source, an event loop implementation usually instructs the operating system kernel to notify the application if an event occurred and then the application sleeps until it is notified by the kernel. When the application is awake again, the event loop will execute a callback function previously registered by the application for the corresponding type of event.</p>
<p>Every library that provides access to a certain event source usually provides such an interface. However, if the application should process events from more than one event source, this approach is not feasible anymore as we cannot execute multiple loop functions with one thread. One solution is to start a separate thread for every event source that each will call the loop function of the corresponding library. However, using multiple threads might cause additional source code complexity due to the required thread synchronization and finding synchronization bugs in multi-threaded applications can become a time-intensive effort if the bugs occur only in rare circumstances.</p>
<p>If events do not have to be processed in parallel to achieve minimal latency, another approach can be used: instead of starting an own event loop for every event source, a generic event loop is started and the single event sources are registered with this loop. Libcortex implements such a generic event loop but also provides a simple interface to start listening to some common event sources in a (Linux) operating system.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Example</h1>
<p>The following code will show information about a USB mass storage device whenever udev detects that one was plugged in:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;crtx/core.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;crtx/udev.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// specific udev attributes we are interested in</span></div>
<div class="line"><span class="keywordtype">char</span> * usb_attrs[] = {</div>
<div class="line">    <span class="stringliteral">&quot;idVendor&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;idProduct&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;manufacturer&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;product&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;serial&quot;</span>,</div>
<div class="line">    0,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// the group of attributes we are interested in</span></div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structcrtx__udev__raw2dict__attr__req.html">crtx_udev_raw2dict_attr_req</a> r2ds[] = {</div>
<div class="line">    { <span class="stringliteral">&quot;usb&quot;</span>, <span class="stringliteral">&quot;usb_device&quot;</span>, usb_attrs },</div>
<div class="line">    { 0 },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// the kind of udev events/devices we are interested in</span></div>
<div class="line"><span class="keywordtype">char</span> *udev_filters[] = {</div>
<div class="line">    <span class="stringliteral">&quot;block&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;partition&quot;</span>,</div>
<div class="line">    0,</div>
<div class="line">    0,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// callback function that is executed if a udev event is received</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> udev_event_handler(<span class="keyword">struct</span> <a class="code hl_struct" href="structcrtx__event.html">crtx_event</a> *event, <span class="keywordtype">void</span> *userdata, <span class="keywordtype">void</span> **sessiondata) {</div>
<div class="line">    <span class="keyword">struct </span><a class="code hl_struct" href="structcrtx__dict.html">crtx_dict</a> *dict;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// optional helper function that converts udev events into a key=value dictionary</span></div>
<div class="line">    dict = crtx_udev_raw2dict((<span class="keyword">struct</span> udev_device *) crtx_event_get_ptr(event), r2ds, 0);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// print the key=value tuples that show information like the corresponding device file in /dev</span></div>
<div class="line">    crtx_print_dict(dict);</div>
<div class="line">    </div>
<div class="line">    crtx_dict_unref(dict);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {</div>
<div class="line">    <span class="keyword">struct </span><a class="code hl_struct" href="structcrtx__udev__listener.html">crtx_udev_listener</a> ulist;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    crtx_init();</div>
<div class="line">    <span class="comment">// optional helper function to gracefully handle standard process signals</span></div>
<div class="line">    crtx_handle_std_signals();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// initialize the control structure of this listener/event source</span></div>
<div class="line">    memset(&amp;ulist, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code hl_struct" href="structcrtx__udev__listener.html">crtx_udev_listener</a>));</div>
<div class="line">    </div>
<div class="line">    ulist.sys_dev_filter = udev_filters;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// initialize this listener</span></div>
<div class="line">    ret = crtx_setup_listener(<span class="stringliteral">&quot;udev&quot;</span>, &amp;ulist);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;create_listener(udev) failed: %s\n&quot;</span>, strerror(-ret));</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// register a callback function</span></div>
<div class="line">    crtx_create_task(ulist.base.graph, 0, <span class="stringliteral">&quot;udev_event&quot;</span>, udev_event_handler, 0);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// start listening for events</span></div>
<div class="line">    ret = crtx_start_listener(&amp;ulist.base);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;starting udev listener failed\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// start the actual event loop</span></div>
<div class="line">    crtx_loop();</div>
<div class="line">    </div>
<div class="line">    crtx_finish();</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="astructcrtx__dict_html"><div class="ttname"><a href="structcrtx__dict.html">crtx_dict</a></div><div class="ttdef"><b>Definition</b> dict.h:61</div></div>
<div class="ttc" id="astructcrtx__event_html"><div class="ttname"><a href="structcrtx__event.html">crtx_event</a></div><div class="ttdoc">an event that is emitted by a listener crtx_listener_base</div><div class="ttdef"><b>Definition</b> core.h:77</div></div>
<div class="ttc" id="astructcrtx__udev__listener_html"><div class="ttname"><a href="structcrtx__udev__listener.html">crtx_udev_listener</a></div><div class="ttdef"><b>Definition</b> udev.h:25</div></div>
<div class="ttc" id="astructcrtx__udev__raw2dict__attr__req_html"><div class="ttname"><a href="structcrtx__udev__raw2dict__attr__req.html">crtx_udev_raw2dict_attr_req</a></div><div class="ttdef"><b>Definition</b> udev.h:18</div></div>
</div><!-- fragment --><p>Please note, some plugins also include example code (used to build a small test application) at the end of the source file which can compiled using the <code>make test</code> command.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Setup</h1>
<p>Depending on the to-be-used plugins, different development packages are required.</p>
<p>On a Debian/Ubuntu-base system, the following command installs a common set of required packages:</p>
<div class="fragment"><div class="line">apt install libavahi-core-dev libsystemd-dev libjson-c-dev libcurl4-gnutls-dev \</div>
<div class="line">    libevdev-dev libnl-3-dev libvirt-dev libnl-genl-3-dev libnetfilter-queue-dev \</div>
<div class="line">    libpulse-dev libreadline-dev libudev-dev libmosquitto-dev</div>
</div><!-- fragment --><p>To configure the build, libcortex uses a simple include file for <code>make</code>, called <code>Makefile.local</code>. This file is automatically created from <code>Makefile.local.skel</code> if it does not exist.</p>
<p>If you want to test libcortex in your home directory, simply call <code>make local</code> to generate a <code>Makefile.local</code> which creates binaries that can be executed from the local directory without installing them in the system. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
